<div class="container py-3">

  <h2 class="mb-3 text-center text-primary"><%= @transaction.transaction_type.capitalize %> Stock</h2>

  <div class="card shadow-sm mb-3 w-50 mx-auto">
    <div class="card-body py-3 px-4">
      <%= form_with url: new_trader_transaction_path, method: :get, local: true do |form| %>
        <div class="mb-2">
          <%= form.label :q, "Stock Symbol", class: "form-label" %>
          <%= form.text_field :q, class: "form-control form-control-sm", placeholder: "e.g. AAPL, TSLA" %>
        </div>
        <%= form.hidden_field :transaction_type, value: @transaction.transaction_type %>
        <%= form.submit "Search", class: "btn btn-sm btn-primary w-100" %>
      <% end %>
    </div>
  </div>

  <% if @symbols.present? %>
    <div class="card shadow-sm mb-3 w-75 mx-auto">
      <div class="card-body p-3">
        <h6 class="mb-3">Search Results</h6>
        <div class="table-responsive">
          <table class="table table-sm table-hover table-bordered align-middle text-center mb-0">
            <thead class="table-dark">
              <tr>
                <th>Symbol</th>
                <th>Name</th>
                <th>Price</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @symbols.each do |symbol| %>
                <% sym = symbol["1. symbol"] %>
                <% name = symbol["2. name"] %>
                <% current_price = StockSymbolService.latest_price(sym) %>
                <% formatted_price = current_price.present? ? number_to_currency(current_price) : "N/A" %>
                <tr>
                  <td><%= sym %></td>
                  <td><%= name %></td>
                  <td><%= formatted_price %></td>
                  <td>
                    <%= link_to "Select", new_trader_transaction_path(transaction_type: @transaction.transaction_type, asset_symbol: sym), class: "btn btn-outline-primary btn-sm" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>

  <% if @transaction.asset_symbol.present? %>
    <div class="card shadow-sm w-50 mx-auto">
      <div class="card-body p-3">
        <%= render "form", transaction: @transaction, price: @price, owned_quantity: @owned_quantity %>
      </div>
    </div>
  <% end %>
</div>
